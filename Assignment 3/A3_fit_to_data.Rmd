---
title: "A3: Fit to data"
author: "Astrid NÃ¸rgaard Fonager"
date: "2023-04-26"
output:
  prettydoc::html_pretty:
    theme: cayman
    highlight: github
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(pacman)
pacman::p_load(tidyverse, brms, cmdstanr, scales, tidyr)
```



```{r load data}
cogsci_data <- read.csv("cogsci_clean.csv") %>% 
  na.omit() %>% 
  mutate(
    FirstRating_probability = FirstRating/9,
    SecondRating_probability = SecondRating/9,
    GroupRating_probability = GroupRating/9
  )

cogsci_data$FirstRating <- as.factor(cogsci_data$FirstRating)
cogsci_data$SecondRating <- as.factor(cogsci_data$SecondRating)
cogsci_data$Change <- as.factor(cogsci_data$Change)

```

# DATA INSPECTION

```{r ratings}

# first rating
cogsci_data %>% 
  ggplot(aes(FirstRating)) +
  geom_bar() +
  theme_classic()

mean(cogsci_data$FirstRating)
sd(cogsci_data$FirstRating)

# second rating
cogsci_data %>% 
  ggplot(aes(SecondRating)) +
  geom_bar() +
  theme_classic()

mean(cogsci_data$SecondRating)
sd(cogsci_data$SecondRating)

```

```{r Change: figure 1}
# fig 1a
cogsci_data %>% 
  ggplot(aes(Change)) +
  geom_bar()

# fig 1b
cogsci_data %>% 
  ggplot(aes(FirstRating, SecondRating)) +
  geom_jitter()

```

```{r feedback vs. change: figure 2}

# fig 2a
cogsci_data %>% 
  ggplot(aes(Change, Feedback, color = Change)) +
  geom_boxplot() +
  theme_classic()

# fig 2b
cogsci_data %>% 
  ggplot() +
  geom_density(aes(Change), fill="blue", alpha=0.3) +
  geom_density(aes(Feedback), fill="red", alpha=0.3) +
  theme_classic()


```


# IMPORT MODELS
```{r import model}

# Simple Bayes model
file_SB <- file.path("stan/SB_model.stan")
model_SB <- cmdstan_model(file_SB, 
                     cpp_options = list(stan_threads = TRUE),
                     stanc_options = list("O1")) 

# Weighted Bayes model
file_WB <- file.path("stan/WB_model.stan")
model_WB <- cmdstan_model(file_WB, 
                     cpp_options = list(stan_threads = TRUE),
                     stanc_options = list("O1")) 
```
# FIT TO DATA

```{r function: prepare data}

prep_data <- function(data, id){
  df <- data %>% 
    filter(ID == id)
  
  data <- list(
  trials = nrow(df),
  rating2 = df$SecondRating_probability,
  rating1 = df$FirstRating_probability,
  other = df$GroupRating_probability
  )
  
  return(data)
}

# test
p1_data <- prep_data(cogsci_data, id = 1)

```

```{r function: fit model to data}

fit_model <- function(data, model, clean = TRUE){
  
  if(model == "SB") {
    # fit Simple Bayes model to data
    samples <- model_SB$sample(
      data = data,
      seed = 1985,
      chains = 2,
      parallel_chains = 2,
      threads_per_chain = 2,
      iter_warmup = 1500,
      iter_sampling = 3000,
      refresh = 500
    )
  }
  
  else if(model == "WB"){
  # fit Weighted Bayes model to data
    samples <- model_WB$sample(
      data = data,
      seed = 1985,
      chains = 2,
      parallel_chains = 2,
      threads_per_chain = 2,
      iter_warmup = 1500,
      iter_sampling = 3000,
      refresh = 500
    )
  }
  
  if(clean == TRUE) {
  # get samples
  draws_df <- as_draws_df(samples$draws())
  
  return(draws_df)
  }
  
  else if(clean == FALSE){
    return(samples)
  }
}

```

## Simple Bayes

```{r fit to SB}

# test
fit2SB <- fit_model(p1_data, model = "SB", clean = F)

```

```{r check model quality}

fit2SB$cmdstan_diagnose()

# Plot hairy caterpillars
draws_df <- as_draws_df(fit2SB$draws())

# bias
ggplot(draws_df, aes(.iteration, bias, group = .chain, color=.chain)) + 
  geom_line() +
  labs(title = "Simple Bayes - Bias") +
  theme_classic()

# SD 
ggplot(draws_df, aes(.iteration, SD, group = .chain, color=.chain)) + 
  geom_line() +
  labs(title = "Simple Bayes - SD") +
  theme_classic()
```

```{r plot fit to SB}
# code requires running fit_model with clean = T
p1 <- cogsci_data %>% 
    filter(ID == 1)

# check participant 1, trial 1 - GOOD FIT
fit2SB %>% mutate(
  predictions = round(inv_logit_scaled(`post_preds[1]`)*9, 0)) %>% 
  ggplot() + 
  aes(predictions) + 
  geom_histogram(fill = "#36802d") + 
  geom_vline(xintercept = 6, linetype="dotted", 
                color = "red", size=1) +
  scale_x_continuous(breaks = scales::pretty_breaks(n = 9)) +
  theme_bw()+ 
  labs(title = "Simple Bayes fit to participant 1, trial 1")


# check participant 1, trial 2 - WORSE FIT
fit2SB %>% mutate(
  predictions = round(inv_logit_scaled(`post_preds[2]`)*9, 0)) %>% 
  ggplot() + 
  aes(predictions) + 
  geom_histogram(fill = "#36802d") + 
  geom_vline(xintercept = 5, linetype="dotted", 
                color = "red", size= 1) +
  scale_x_continuous(breaks = scales::pretty_breaks(n = 9)) + 
  theme_bw()+ 
  labs(title = "Simple Bayes fit to participant 1, trial 2")

```


## Weighted Bayes

```{r fit to WB}

# test
fit2WB <- fit_model(p1_data,  model = "WB", clean = F)

```

```{r check model quality}

fit2WB$cmdstan_diagnose()

# Plot hairy caterpillars
draws_df <- as_draws_df(fit2WB$draws())

# bias
ggplot(draws_df, aes(.iteration, bias, group = .chain, color=.chain)) + 
  geom_line() +
  labs(title = "Simple Bayes - Bias") +
  theme_classic()

# SD 
ggplot(draws_df, aes(.iteration, SD, group = .chain, color=.chain)) + 
  geom_line() +
  labs(title = "Simple Bayes - SD") +
  theme_classic()
```

```{r plot fit to WB}
# code requires running fit_model with clean = T

# check participant 1, trial 1 - GOOD FIT
fit2WB %>% mutate(
  predictions = round(inv_logit_scaled(`post_preds[1]`)*9, 0)) %>% 
  ggplot() + 
  aes(predictions) + 
  geom_histogram(fill = "#77ab59") + 
  geom_vline(xintercept = 6, linetype="dotted", 
                color = "red", size=1) +
  scale_x_continuous(breaks = scales::pretty_breaks(n = 9)) +
  theme_bw()+ 
  labs(title = "Weighted Bayes fit to participant 1, trial 1")


# check participant 1, trial 2 - WORSE FIT
fit2WB %>% mutate(
  predictions = round(inv_logit_scaled(`post_preds[2]`)*9, 0)) %>% 
  ggplot() + 
  aes(predictions) + 
  geom_histogram(fill = "#77ab59") + 
  geom_vline(xintercept = 5, linetype="dotted", 
                color = "red", size= 1) +
  scale_x_continuous(breaks = scales::pretty_breaks(n = 9)) + 
  theme_bw()+ 
  labs(title = "Weighted Bayes fit to participant 1, trial 2")

```

# MODEL COMPARISON

When we have multiple participants:
- fit each model for each participant (subset for all participants and fit SB and WB to the data)
- do model comparison on SB and WB for each participant
- summarise the results in a confusion matrix or see how many participants belong to (fit best) each of the models

```{r function: model comparison}

compare <- function(fit1 = fit2SB, fit2 = fit2WB, id){
  # Simple Bayes
  Loo_SB <- fit1$loo(save_psis = TRUE, cores = 4)

  # Weighted Bayes
  Loo_WB <- fit2$loo(save_psis = TRUE, cores = 4)
  
  # model weights
  temp <- loo_model_weights(list(Loo_SB, Loo_WB))
  
  df <- tibble(ID = id, SimpleBayes = temp[1], WeightedBayes = temp[2])
  
  return(df)
}

# test: requires running fit_model() with clean = F
Loo_SB <- fit2SB$loo(save_psis = TRUE, cores = 4)
Loo_SB$pointwise[, "elpd_loo"]


Loo_WB <- fit2WB$loo(save_psis = TRUE, cores = 4)
Loo_WB$pointwise[, "elpd_loo"]

loo_compare(Loo_SB, Loo_WB)
loo_model_weights(list(Loo_SB, Loo_WB))

```


```{r loop through participants}
start_time <- Sys.time()

participants <- 45

MC_data <- tibble()

for (p in 1:participants){
  # prepare data
  data <- prep_data(cogsci_data, p)
  # fit to simple bayes
  fit2SB <- fit_model(data, model = "SB", clean = F)
  # fit to weighted bayes
  fit2WB <- fit_model(data, model = "WB", clean = F)
  # compare models
  comparison <- compare(fit1 = fit2SB, fit2 = fit2WB, p)
  # append to df
  MC_data <- rbind(MC_data, comparison)
}

end_time <- Sys.time()
processing_time <- end_time - start_time
```

```{r count and plot}

hist(MC_data$SimpleBayes)
hist(MC_data$WeightedBayes)

MC_data <- MC_data %>% mutate(
  best_model = factor(ifelse(SimpleBayes > WeightedBayes,"Simple","Weighted"))
)

# count
table(MC_data$best_model)

df <- gather(by_year_percentage, key = measure, value = Rate, 
c("deathpercentage", "tamponadepercentage", "protaminepercentage"))

ggplot(df, aes(x=arrivaldate, y = Rate, group = measure, colour = measure)) + 
geom_line()

# bar plot
MC_data %>% 
  ggplot(aes(x = best_model, fill = best_model)) +
  geom_bar(alpha = 0.8) +
  theme_bw() +
  labs(x = "Best model") +
  scale_fill_discrete(name = "")

# density plot
MC_data %>% 
  ggplot() +
  geom_density(aes(WeightedBayes, fill="Weighted"), alpha=0.5) +
  geom_density(aes(SimpleBayes, fill="Simple"), alpha=0.5) +
  labs(x = "Model weight") +
  theme_bw() +
  scale_fill_manual(values = c('Weighted' = 'blue', 'Simple' = 'red')) +
  scale_fill_discrete(name = "")

```



```{r struggles}

# Simple Bayes
Loo_SB <- fit2SB$loo(save_psis = TRUE, cores = 4)
plot(Loo_SB)


# Weighted Bayes
Loo_WB <- fit2WB$loo(save_psis = TRUE, cores = 4)
plot(Loo_WB)


# compare
loo_compare(Loo_SB, Loo_WB)

loo_model_weights(list(Loo_SB, Loo_WB))
```

```{r loo plot}

elpd <- tibble(
  n = seq(70),
  diff_elpd = 
  Loo_SB$pointwise[, "elpd_loo"] - 
  Loo_WB$pointwise[, "elpd_loo"])

p1 <- ggplot(elpd, aes(x = n, y = diff_elpd)) +
  geom_point(alpha = .1) +
  #xlim(.5,1.01) +
  #ylim(-1.5,1.5) +
  geom_hline(yintercept = 0, color = "red", linetype = "dashed") +
  theme_bw()

p1

```

